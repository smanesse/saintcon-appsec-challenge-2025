(eval-when (:compile-toplevel :load-toplevel :execute) (ql:quickload '(:clack :woo :cffi :lack :alexandria :flexi-streams :log4cl :com.inuoe.jzon)))
(defpackage :itrivia (:use :cl) (:export :main))
(in-package :itrivia)

(cffi:define-foreign-library sqlite3 (:unix (:or "libsqlite3.so.0" "libsqlite3.so")))
(cffi:use-foreign-library sqlite3)
(cffi:defctype db-p :pointer)
(cffi:defcfun ("sqlite3_open" db-up) :int (filename :string) (ppdb (:pointer db-p)))
(cffi:defcfun ("sqlite3_close_v2" db-down) :int (db db-p))
(cffi:defcfun ("sqlite3_exec" ex) :int (db db-p) (sql :string) (callback :pointer) (arg :pointer) (errmsg :pointer))

(defvar *r* nil)

(cffi:defcallback %exec-callback :int
    ((arg :pointer) (ncols :int) (values (:pointer :string)) (colnames (:pointer :string)))
  (declare (ignore arg))
  (let ((row
          (loop for i below ncols
                append (list (intern (string-upcase (cffi:mem-aref colnames :string i))
                                     :keyword)
                             (or (cffi:mem-aref values :string i) "")))))
    (push row *r*))
  0)

(defun dbex (&rest vals)
  (cffi:with-foreign-object (pp 'db-p)
    (let ((rc (db-up "./itrivia.db" pp)))
      (if (plusp rc)
          (values nil rc)
          (let ((db (cffi:mem-ref pp 'db-p)))
            (unwind-protect
                 (let ((*r* nil))
                   (let ((rc2 (ex db (format nil "狺鲠祗ㄣ骀楹汜祆忉汶ュ邈汜祆忉汶ㄣ骀楹铛祆痫轭翦颟ㄣ骀楹铛祆痫轭翦颟┅鲠祯弩铗弼弪箦颡蜚博┅ㄤ猸滹黝溻┅┅┅ㄤ彐躅骘蝽狒鲠祯ㄩ铕豸篝蜷铉鏖翳秕麴豸麸篝蜷铉螬祜镳骘汨狎徙蝻篌轭瘐舡篝蜷铉滹痱轭汨狎螬麒孱ㄣ栳蚪汨狎＼З痱轭汨狎螬┅┅ㄤ彐疳蜥礤翦泔蝮桢徜弪螳Ж横沣弩蟓泔铘蝻飙犰祜鳝矧殓轭横沣弩蟓泔铘蝻飙犰祜鳝礤翳镤⑶旁邢釉姓袁呐膛耘闲陨衔英横沣弩蟓泔铘蝻飙犰祜鳝桢徜弪⒚镱翦铘赠疱阵弪横沣弩蟓泔铘蝻飙磲徵⒏洞鞍⒚弦桢徜弪螈ㄤ彐疳蜥礤翦桢徜弪螳ㄡ痧孱Ж恒镱翦铘豉疱Ⅳ屮舣痨衢罨汨狎箦艚豸姝涪泔蝮桢徜弪螳⒛彐狨祠蝈箴镱箦桢徜弪螈ㄤ彐疳蜥礤翦犰祜麇洵聃弩糸镱螳⒘铢躞弪汜镱禊犷篦弪翳轶磲铢聃弩糸镱螈ㄤ彐疳蜥礤翦躅狨翳矧辁邃啜窗桢徜弪螳á疹狨翳矧辁邃┅⒄钺豸栾蜷邃蝈箴镱箦ㄤ彐躅躞弪汨邈ㄨ遽溴蝮戾è蝈ㄤ忮⒂盘琶埔贤躞弪兹乓泔溴Бㄧ弭栳箬Ⅴ箦颌桢徜弪螬Б┅ㄩ蝈ㄦ轵篝蝈螬铋飑┅ㄤ彐磲泸梏麴孱骘蜚瀛骘钺礤蝈篝沆狨箦螬啜躅戾篌ㄡ钿楞灬躞弩舂蝈趱蝾骝镯钺礤躅狨翳矧辁邃┅ㄤ彐磲泸珏翩轭盹溴骈屐洎啜矧疳蝮瀛轭翦珏矧ㄧ弭盹溴骈屐洎阿宏躅氕犰祜麇舂癌ㄤ彐躅箝铉戾趄轹獒聃弪眭祠戾舄è孱糸豉泔躅ǐ蜥钿镯垢┅ㄢ狍瀛犷篦弪ㄦ祜矧í眭祠孱糸豉泔躅舂┅ㄤ弭弪蜥铘ō蜥钿镯脖卑┅族汜瞌栳鲥疱镳戾鏖铑轭绗蜷玷艨扉篝ㄦ矧磲铋聃弪孱糸豉泔躅舂ǐ忉箦犷篦弪溴翦蝌犷舂┅ㄤ彐躅珏铄蜥翦趄轹獒ī铘蜥钿镯俯扉篝箝铉戾趄轹獒⑷秣磲铢徜蹯磲戾酋轵悯汶镲骈轭麸徜蹯磲戾嘛蝾屣轩珥澎屦栳铘罂卜饭珐箝铉戾趄轹獒⑷秣磲铢箦泔钿狎轭遽蝮竣潮档豆捕箝铉戾趄轹獒⑷秣磲铢栾磲铢镱滹祆狎忾祆麇蝈痱轭翦镱狯弪徵轭箦泔钿轭舶泊竣洞箝铉戾趄轹獒⑸犷玳鲥溽疱蜷镤轭舶倍栾磲铢疱镳戾溟邃骝镯筱矧痖镱竣卑箝铉戾趄轹獒⑸酗提躜孱糸桢熹栝黠蜢洵蝈泔蜾疳沐骘栾躜蟋栾磲铢瘐箬躔鏖祆桢栳鲥滹铄竣吵犯箝铉戾趄轹獒⑷秣磲铢泔麸铉蹂黠蹯轸翎脲麸汩蜚戾翳盹镱糸礤狒篚蜴徙戾鲥炜傅蛋俺订箝铉戾趄轹獒⑸犷玳鲥黹祆孱轷疱蜷镤犷狯弪徵轫盹螋犰另弪殂犷遽趔栾磲铢怩蜱弪罂钡栋鞍箝铉戾趄轹獒⒘樾栾铄倍序歪泔铙蹴弩栾磲铢麽趑镦痫麇镱狯弪徵轭栾躜疱蜷镤竣钞吹┅┅ㄤ彐躅轭溴ㄥ铞ㄤ邈灬蝈ㄩ珙矧孱雯啜舶ㄡ痧孱Ж恒镱翦铘豉疱Ⅳ屮舣梏盱汨狎箦艚豸姝涪泔蝮桢徜弪螳ì鏖翳镳孱骈戾ㄦ殪瀛Ｐ瘐忪殂轭溴梏盱轰轵邈糸镱洪铕豸洪姝滹弩铒舡屮轶铋飑戾è磲脲篝蜷铉ㄦ殪瀛戾铉翳骈戾螬┅蝈徜箦聃孱沐骈戾螬螬┅┅ㄤ彐躅铄ㄥ铞ㄤ邈灬蝈ㄩ珙矧孱雯啜舶桢徜弪螳ì痱镧ㄧ弭ㄣ狎ㄤ忮⑸斡乓晌韵躞弪呐屏仗至陶庞遗哉椅晌泔溴┅恒镤濠┅┅ㄤ彐躅铄ㄥ铞ㄤ弩趄蹉趱蜷铉忾钿é脲桢徜弪犰祜鳝雉桢颦脲螬孱戾舄è躞弪蝻躞弪汨邈桢徜弪螬ㄣ桢汶ㄨ趑瓠孱骘蜚瀛骘铄躞弪蝻ㄧ弭姝轭躞弪蝻横铙麇蝮哏轹孱犰祜麇洵聃弩糸镱螳ㄤ忮⒂盘琶埔贤躞弪兹乓殇ㄧ弭姝轭躞弪蝻洪洎廖沲蝌孱暨聃弩糸镱唛捎握烫┅趄轹獒ㄧ孱弪狒瀛趄轹獒┅趄轹獒殇ㄧ弭ㄦ轵篝ㄤ忮⑸斡乓晌韵趄轹獒聃弩糸镱犷篦弪至陶庞ěㄦ轵篝趄轹獒КБ箦泔钿趄轹獒З遗哉椅晌殇┅洪洎┅ㄤ邈灬蝈ㄩ珙矧汨邈氅ㄤ忮⒄心猎躞弪优沲蝌孱暨聃弩糸镱唛趄轹獒殇兹乓殇ㄧ弭躞弪蝻洪洎啜舶桢徜弪螳ìㄦ轵篝趄轹獒┅┅┅ㄤ彐躅篝狒躞ㄥ铞ㄤ弩趄蹉趱蜷铉忾钿é脲桢徜弪犰祜鳝雉桢颦脲螬孱戾舄è躞弪蝻躞弪汨邈桢徜弪螬ㄣ桢汶ㄨ趑瓠孱骘蜚瀛骘篝狒躞躞弪蝻鳗ㄡ铙麇蝮玳鲥ㄧ弭姝轭躞弪蝻横铙麇蝮哏轹孱┅ㄧ犴瀛秭弪ㄩ窘犷篦弪蟓玳鲥犰祜麇洵聃弩糸镱螳⒃艺泞⑵撂优┅黹瞽溴祠ㄧ弭姝轭躞弪蝻喉轭哏蹂篌咪屐翎┅趄轹獒祜镳骘趄轹獒轭矧ㄤ忮⒂盘琶埔贤躞弪筮趄轹獒豸兹乓豸躞弪唛ㄧ弭躞弪蝻洪洎弦呐沦豸犷篦弪唢蜾弪劣芒Ж┅骘骝镯泔祆邈戾è趄磲脲栳箬翎忪濠┅箦翩ㄧ弭栳箬с矧蝈泗趄篝蜷铉⒈ㄧ弭趄轹獒恒矧蝈泗┅箦翩ㄧ弭栳箬т屐翎趄ㄧ弭姝轭趄轹獒虹蹂篌咪屐翎┅箦翩ㄧ弭栳箬ч钿屮趄椹趄┅蝈箴镱箦磲脲栳箬翎忪濠┅ㄤ邈灬蝈ㄩ珙矧汨邈氅箦翩ㄧ弭栳箬х犴暹秭弪蝈箴镱箦篝蜷铉玑礤秭弪⒃艺泞┅箦翩ㄧ弭栳箬ы轭哏蹂篌咪屐翎蝈箴镱箦黹瞽溴祠岍箦翩ㄧ弭栳箬п祆秣邃唏蹂篝轱铙蝈箴镱箦犰祜麇洵聃弩糸镱螳箦翩ㄧ弭栳箬п铙麇蝮哏轹孱蝈箴镱箦犷篦弪蟓玳鲥瞟箦翩ㄧ弭栳箬趄轹獒唑弩蹯趔蝈箴镱箦矧趄轹獒磲脲狎蜥癌┅啜舶桢徜弪螳ìㄣ镯轭躏瀹犏镱后趄轭玳纟蝈箴镱箦┅┅┅ㄤ彐躅犷篦弪ㄥ铞ㄤ弩趄蹉趱蜷铉忾钿é脲桢徜弪蜥鳝怙澌犰祜鳝雉桢颦脲螬孱戾舄è躞弪蝻躞弪汨邈桢徜弪螬ㄣ桢汶ㄨ趑瓠孱骘蜚瀛骘犷篦弪躞弪蝻ㄧ弭姝轭躞弪蝻横铙麇蝮哏轹孱犰祜麇洵聃弩糸镱螳铒ㄤ忮⒂盘琶埔贤躞弪兹乓殇ㄧ弭躞弪蝻洪洎廖沲蝌孱暨聃弩糸镱唛捎握烫┅铒ㄤ忮⒂盘琶埔贤躞弪筮趄轹獒兹乓躞弪唛ㄧ弭躞弪蝻洪洎廖趄轹獒唛ㄧ弭躞弪蝻恒躜蝈铘唏蹂篝轱钸殇┅┅ㄢ翦鲥泗矧ㄡ戾犷潋獒候遽洵篝蝈犴泔铘孱舡轭麸怡翦鲥泗矧蜥鳝怙澌┅ㄢ镤篝蜷铉ㄦ矧磲舡鲠祯ㄦ戾榄篝蝈犴蠛镢翦趔麸篝蜷铉怡翦鲥泗矧哄翦蝾犰骘蝽狒乎翩俯┅躞弪犷篦弪轭矧疳蝮瀛轭翦珏怙澌篝蜷铉宏躅氕犰祜麇舂蝈趱蝾骝镯犷篦弪躅狨翳矧辁邃┅ㄤ猸犷篦弪汨邈ㄤ忮⒂盘琶昧优兹盼趄轹獒犷篦弪Б怙澌篝蜷铉匀盼砸张盘优屏逃盼劣泔蝌邈衄趄轹獒犷篦弪⑵蚁趄轹獒膛圃氏晌躞弪镱躞弪螽沲蝌孱暨聃弩糸镱唛趄轹獒殇兹乓躞弪螽殇ㄧ弭躞弪蝻洪洎┅ㄩ蟓泔蝌邈ㄡ钿溻犷篦弪汨邈篝蜷铉⒈ㄧ弭ㄦ轵篝溻犷篦弪汨邈氅恒矧蝈泗┅┅ㄣ矧蝈泗犷篦弪麒孱溻犷篦弪汨邈ㄧ弭姝轭ㄦ轵篝溻犷篦弪汨邈氅横铙麇颟┅ㄤ殒驽蝈钽麒孱ㄡ钿泔蝌邈舡犷篦弪铒轶泔蝌邈舂ㄡ怏ō躞弪犷篦弪轭泔蝌邈舡犷篦弪┅┅蝈箴镱箦ㄩ轶泔蝌邈⒃艺泞ㄦ矧磲铋⑵撂优湖岷幄泔蝌邈舡犷篦弪溟骀弪孱沐┅┅ㄤ邈灬蝈ㄩ珙矧汨邈氅ㄤ忮⑸斡乓晌韵躞弪筮趄轹獒ㄡ铙麇蜻矧溴颥躞弪唛洮趄轹獒唛洮泔蝌邈衄珲弩筮溴祠岍至陶庞áㄧ弭ㄦ轵篝ㄤ忮⒂盘琶孟瘴渊劣泔躅埔贤躞弪筮趄轹獒兹乓躞弪唛ㄧ弭躞弪蝻洪洎┅恒秕铘ㄧ弭躞弪蝻洪洎ㄧ弭躞弪蝻恒躜蝈铘唏蹂篝轱钸殇ㄩ轶泔蝌邈⒃艺泞⑵撂优矧溟骀弪孱沐癌ㄤ忮⒄心猎沼乓优沲蝌孱暨聃弩糸镱唛握烫兹乓殇ㄧ弭躞弪蝻洪洎啜舶桢徜弪螳ì蝈箴镱箦┅┅ㄤ彐疳蜥礤翦狃皙灬礅溽ㄥ铞ㄤ弩趄蹉趱蜷铉忾钿é脲疳翳轭骘蝈聃弩舡礤翳镤犰祜鳝雉桢颦脲螬孱换柔钿戾闲陨衔痱彐扉玷蝈聃弩趔ㄩㄥ蝈聃弩舡礤翳镤猴痿轱铙啜舶泔蝮桢徜弪螳á┅ㄣ镱è篝蜷铉疳翳轭骘ㄩ钿屮孱雯è篝蜷铉疳翳轭骘铄鳍铄孱雯è篝蜷铉疳翳轭骘铄簪铄孱雯è篝蜷铉疳翳轭骘篝狒躞篝狒躞孱雯è篝蜷铉疳翳轭骘犷篦弪ㄡ铙麇孱雯Ж窗铋á物骑躅洧┅┅┅┅ㄤ彐躅磲轭īㄤ忮⒚遗猎粤绿善蜗咆捎杂躞弪á殇晌耘桥幸赏烈伺佻泔溴耘卦蜗握烫瘴裳张衔孟纹躺迷蚁烫铝盟萌琶栓膛吻匀ㄣ镤濠钡呐屏仗牧耘陨团ī滔着舀扰亘伊文贤绿下ú旦┅┈泔蝌邈暨犷篦弪晌耘桥蜗握烫呐屏仗萌琶栓冀泔蝌邈暨犷篦弪廖泔蝌邈暨犷篦弪冀卑癌犷篦弪筮玳鲥晌耘桥蜗握烫呐屏仗萌琶栓冀犷篦弪筮玳鲥廖犷篦弪筮玳鲥冀畅沲蝌孱暨聃弩糸镱唛晌耘桥椰黹钸珲弩筮溴祠晌耘桥椰葡遗汕伺ㄣ躜蝈铘唏蹂篝轱钸殇遗婆遗蚊庞趄轹獒ㄩ洎ㄤ忮⒚遗猎粤绿善蜗咆捎杂趄轹獒á殇晌耘桥幸赏烈伺佻聃弩糸镱耘卦蜗握烫萌琶栓膛吻匀聃弩糸镱冀驳旦犷篦弪晌耘桥蜗握烫呐屏仗阿ㄤ忮⒚遗猎粤绿善蜗咆捎杂躞弪筮趄轹獒á犷篦弪唢蜾弪晌耘桥蜗握烫躞弪唛晌耘桥蜗握烫趄轹獒唛晌耘桥蜗握烫泔蝌邈孪咸帕蜗握烫萌琶栓泔蝌邈轭ò暴┈珲弩筮溴祠晌耘桥蜗握烫呐屏仗艾葡遗汕伺侉躞弪唛洎遗婆遗蚊庞躞弪蟥殇┈葡遗汕伺侉趄轹獒唛洎遗婆遗蚊庞趄轹獒ㄩ洎幸赏烈伺侉躞弪唛洮趄轹獒唛洎衔孟纹躺迷汕蜗遗ㄤ忮⒚遗猎砸汕桥善蜗咆捎杂躔溽翦唧翎趱⒘圃乓晌优以衔躞弪筮趄轹獒屡巧招牧耘躞弪螈优泔蝌邈暨犷篦弪á优膛迷孟瘴渊埔贤躞弪筮趄轹獒豸颌兹乓豸虍躞弪唛躞弪螽殇廖豸虍泔蝌邈砸张┈犷篦弪筮玳鲥á优膛迷孟瘴渊埔贤躞弪筮趄轹獒豸虿兹乓豸虿躞弪唛躞弪螽殇┈黹钸珲弩筮溴祠á优膛迷蜕唯珲弩筮溴祠岍埔贤躞弪筮趄轹獒豸虺兹乓豸虺躞弪唛躞弪螽殇兹乓闻桩躞弪唛躞弪螽殇虎⑴文ㄤ彐疳蜥礤翦箦蝣弪ㄣ灬汶恒灬汶躔灬汶衡蹰熹弪ê篝狒殂吼狒狍箦趔候镲Ｐ瘐忪殂狍箦趔ê篝狒殂吼狒麽箜候镲Ｐ瘐忪殂麽箜狃皙后弪鲥瑚镲吼矧栋岸横滗蝈篌爱爱爱阿┅磲轭